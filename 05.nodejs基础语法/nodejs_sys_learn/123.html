<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <style>
    #crop_image {
      float: left;
      width: 55%;
      background-color: #333;
      user-select: none;
      margin: 3% 20%;
      border: 1px solid #DEDEDE;
      -webkit-border-radius: 6px;
      -moz-border-radius: 6px;
      border-radius: 6px;
      -webkit-box-shadow: 1px 1px 5px 2px rgba(0, 0, 0, 0.2);
      -moz-box-shadow: 1px 1px 5px 2px rgba(0, 0, 0, 0.2);
      box-shadow: 1px 1px 5px 2px rgba(0, 0, 0, 0.2);
    }

    #crop_image_top,#crop_image_bottom {
      float: left;
      width: 96%;
      padding: 2%;
      background-color: white;
    }
    /* 底部 */
    #crop_image_bottom {
      text-align: right;
    }

    #crop_image_bottom input {
      height: 30px;
      padding: 5px 15px;
      border-radius: 3px;
      border: none;
      margin-left: 20px;
      outline: none;
    }

    #submitBtn {
      background-color: #40aff2;
      color: white;
      cursor: pointer;
    }

    #submitBtn:HOVER {
      background-color: #409ff2;
    }
    /* 顶部 */
    #crop_image_top h4 {
      margin: 0;
      padding: 0;
      font-weight: normal;
    }
    /* 裁剪部分 */
    #crop_image_content {
      float: left;
      position: relative;
      text-align: center;
      width: 92%;
      margin: 4%;
    }

    #cropBox {
      position: relative;
    }

    #crop_image_content #cropimg1 {
      opacity: 0.5;
      position: absolute;
      top: 0;
      left: 0;
    }

    #crop_image_content #cropimg2 {
      position: absolute;
      top: 0;
      left: 0;
      clip: rect(0, 150px, 150px, 0);
    }

    #crop_image_content #mainBox {
      border: 1px solid white;
      position: absolute;
      top: 0;
      left: 0;
      width: 150px;
      height: 150px;
      cursor: move;
    }

    .minBox {
      position: absolute;
      height: 8px;
      width: 8px;
      background-color: white;
    }

    .left-up {
      top: -4px;
      left: -4px;
      cursor: nw-resize;
    }

    .up {
      left: 50%;
      margin-left: -4px;
      top: -4px;
      cursor: n-resize;
    }

    .right-up {
      right: -4px;
      top: -4px;
      cursor: ne-resize;
    }

    .left {
      top: 50%;
      margin-top: -4px;
      left: -4px;
      cursor: w-resize;
    }

    .right {
      top: 50%;
      margin-top: -4px;
      right: -4px;
      cursor: w-resize;
    }

    .left-down {
      bottom: -4px;
      left: -4px;
      cursor: sw-resize;
    }

    .down {
      bottom: -4px;
      left: 50%;
      margin-left: -4px;
      cursor: s-resize;
    }

    .right-down {
      bottom: -4px;
      right: -4px;
      cursor: se-resize;
    }
    /* 预览框 */
    #preview {
      position: absolute;
      top: 0;
    }

    #preview #cropimg3 {
      position: absolute;
    }

    /* 上传图片区域 */
    #uploadForm {
      float: left;
      margin: -2% 20% 5% 20%;
    }

    #uploadImage {
      position: relative;
      width: 372px;
      height: 202px;
      background-color: #40aff2;
      text-align: center;
    }

    #uploadImage #cropimg4 {
      position: absolute;
      height: 100%;
      width: 100%;
      padding: 0;
      margin: 0;
      top: 0;
      left: 0;
    }

    #uploadImage .addImage {
      display: inline-block;
      position: relative;
      min-width: 80px;
      height: 40px;
      overflow: hidden;
      padding: 0 30px;
      margin: 81px auto;
      border: none;
      background-color: #F3F3F3;
      color: #555;
      font: 14px/40px 'MicroSoft Yahei', 'Simhei';
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      -webkit-border-radius: 3px;
      -moz-border-radius: 3px;
      border-radius: 3px;
    }

    #uploadImage .addImage:HOVER {
      background-color: #DEDEDE;
    }

    #uploadImage #imgFile
    {
      display: block;
      position: absolute;
      top: 0;
      left: 0;
      width: 140px;
      height: 40px;
      cursor: pointer;
      cursor: hand;
      border: none;
      font-size: 0;
      padding: 0;
      /* older safari/Chrome browsers */
      -webkit-opacity: 0;
      /* Netscape and Older than Firefox 0.9 */
      -moz-opacity: 0;
      /* Safari 1.x (pre WebKit!) 老式khtml内核的Safari浏览器*/
      -khtml-opacity: 0;
      /* IE9 + etc...modern browsers */
      opacity: 0;
      /* IE 4-9 */
      filter:alpha(opacity=0);
      /*This works in IE 8 & 9 too*/
      -ms-filter:"progid:DXImageTransform.Microsoft.Alpha(Opacity=0)";
      /*IE4-IE9*/
      filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=0);
    }

    #uploadImage #imgFile::-webkit-file-upload-button {
      display: block;
      position: absolute;
      top: 0;
      left: 0;
      width: 140px;
      height: 40px;
      cursor: pointer;
      cursor: hand;
      border: none;
      font-size: 0;
      padding: 0;
      /* older safari/Chrome browsers */
      -webkit-opacity: 0;
      /* Netscape and Older than Firefox 0.9 */
      -moz-opacity: 0;
      /* Safari 1.x (pre WebKit!) 老式khtml内核的Safari浏览器*/
      -khtml-opacity: 0;
      /* IE9 + etc...modern browsers */
      opacity: 0;
      /* IE 4-9 */
      filter:alpha(opacity=0);
      /*This works in IE 8 & 9 too*/
      -ms-filter:"progid:DXImageTransform.Microsoft.Alpha(Opacity=0)";
      /*IE4-IE9*/
      filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=0);
    }
  </style>
</head>
<body>
<%-- 裁剪图片布局 --%>
<div id="crop_image">
  <div id="crop_image_top">
    <h4>编辑图片</h4>
    <!-- <a>X</a> -->
  </div>

  <div id="crop_image_content">
    <%-- 裁剪部分 --%>
    <div id="cropBox">
      <img id="cropimg1" alt="" src="images/test.jpg">
      <img id="cropimg2" alt="" src="images/test.jpg">
      <%-- 裁剪框 --%>
      <div id="mainBox">
        <div id="left-up" class="minBox left-up"></div>
        <div id="up" class="minBox up"></div>
        <div id="right-up" class="minBox right-up"></div>
        <div id="left" class="minBox left"></div>
        <div id="right" class="minBox right"></div>
        <div id="left-down" class="minBox left-down"></div>
        <div id="down" class="minBox down"></div>
        <div id="right-down" class="minBox right-down"></div>
      </div>
    </div>
    <%-- 预览部分 --%>
    <div id="preview">
      <img id="cropimg3" alt="" src="images/test.jpg">
    </div>
  </div>

  <div id="crop_image_bottom">
    <input class="btn" type="button" value="取消">
    <input id="submitBtn" class="btn" type="button" value="确定" onclick="saveCropImage()">
  </div>
</div>

<!-- 上传图片表单 -->
<form id="uploadForm" action="">
  <div id="uploadImage">
    <img id="cropimg4" alt="" src="images/test.jpg">
    <a href="javascript:;" class="addImage">
      <span>上传图片</span>
      <input id="imgFile" type="file" name="imgFile">
    </a>
  </div>
</form>
<script>
  // 实现图片裁剪功能
  window.onload = function() {
    document.onselectstart=new Function('event.returnValue=false;');
    // 裁剪框拖动
    $("#mainBox").draggable({containment: 'parent', drag: setChoice});

    // 获取裁剪框移动范围
    var cropimgElem = document.getElementById("cropimg1");
    var cropimgElemWidth = cropimgElem.clientWidth;
    var cropimgElemHeight = cropimgElem.clientHeight;
    var cropimgElemPosition = getPosition(cropimgElem);
    var minX = cropimgElemPosition.left;// 待裁剪的图片最小x坐标
    var maxX = cropimgElemPosition.left + cropimgElemWidth;// 待裁剪的图片最大x坐标
    var minY = cropimgElemPosition.top;// 待裁剪的图片最小y坐标
    var maxY = cropimgElemPosition.top + cropimgElemHeight;// 待裁剪的图片最大y坐标

    // 动态设置父控件的宽度和高度
    var cropBox = document.getElementById("cropBox");
    cropBox.style.width = cropimgElemWidth + "px";
    cropBox.style.height = cropimgElemHeight + "px";
    // 预览框设置
    var preview = document.getElementById("preview");
    preview.style.width = cropimgElemWidth + "px";
    preview.style.height = cropimgElemHeight + "px";
    preview.style.left = cropimgElemWidth + 10 + "px";

    // 裁剪框内相关元素
    var mainBoxElem = document.getElementById("mainBox");// 裁剪框
    var rightElem = document.getElementById("right");
    var upElem = document.getElementById("up");
    var leftElem = document.getElementById("left");
    var downElem = document.getElementById("down");
    var leftUpElem = document.getElementById("left-up");
    var rightUpElem = document.getElementById("right-up");
    var leftDownElem = document.getElementById("left-down");
    var rightDownElem = document.getElementById("right-down");

    var ifKeyDown = false;// 鼠标按下事件
    var contact = "";// 表示被按下触点
    // 鼠标按下事件
    rightElem.onmousedown = function(e) {
      e.stopPropagation();
      ifKeyDown = true;
      contact = "right";
    };
    upElem.onmousedown = function(e) {
      e.stopPropagation();
      ifKeyDown = true;
      contact = "up";
    };
    leftElem.onmousedown = function(e) {
      e.stopPropagation();
      ifKeyDown = true;
      contact = "left";
    };
    downElem.onmousedown = function(e) {
      e.stopPropagation();
      ifKeyDown = true;
      contact = "down";
    };
    leftUpElem.onmousedown = function(e) {
      e.stopPropagation();
      ifKeyDown = true;
      contact = "left-up";
    };
    rightUpElem.onmousedown = function(e) {
      e.stopPropagation();
      ifKeyDown = true;
      contact = "right-up";
    };
    leftDownElem.onmousedown = function(e) {
      e.stopPropagation();
      ifKeyDown = true;
      contact = "left-down";
    };
    rightDownElem.onmousedown = function(e) {
      e.stopPropagation();
      ifKeyDown = true;
      contact = "right-down";
    };
    // 鼠标松开事件
    window.onmouseup = function(e) {
      ifKeyDown = false;
      contact = "";
    };
    // 鼠标移动事件
    window.onmousemove = function(e) {
      e.stopPropagation();
      if (ifKeyDown == true) {
        switch (contact) {
          case "right":
            rightMove(e);
            break;
          case "up":
            upMove(e);
            break;
          case "left":
            leftMove(e);
            break;
          case "down":
            downMove(e);
            break;
          case "left-up":
            leftMove(e);
            upMove(e);
            break;
          case "right-up":
            rightMove(e);
            upMove(e);
            break;
          case "left-down":
            leftMove(e);
            downMove(e);
            break;
          case "right-down":
            rightMove(e);
            downMove(e);
            break;
          default:
            break;
        }
        setChoice();
      }
    };

    setChoice();// 初始化选择区域可见

    // 右边移动
    function rightMove(e) {
      var x = e.clientX;// 鼠标x坐标
//      if(x > getPosition(cropimgElem).left + cropimgElem.offsetWidth){
//          x = getPosition(cropimgElem).left + cropimgElem.offsetWidth;
//      }
      if (x > maxX || x < minX) {
        return;
      }
      var widthBefore = mainBoxElem.offsetWidth -2;// 裁剪框变化前的宽度
      var addWidth = x - getPosition(mainBoxElem).left - widthBefore;// 鼠标移动后，裁剪框增加的宽度
      var width = widthBefore + addWidth;
      if (width < 1) {
        return;
      }
      mainBoxElem.style.width = width + "px";// 裁剪框变化后，设置宽度
    };

    // 上边移动
    function upMove(e) {
      var y = e.clientY;// 鼠标y坐标
//      if(y < getPosition(cropimgElem).top){
//          y = getPosition(cropimgElem).top;
//      }
      if (y > maxY || y < minY) {
        return;
      }
      var mainY = getPosition(mainBoxElem).top;// 裁剪框相对于屏幕上边的距离
      var addHeight = mainY - y;// 增加的高度
      var heightBefore = mainBoxElem.offsetHeight - 2;// 裁剪框变化前的高度
      var height = heightBefore + addHeight;
      if (height < 1) {
        return;
      }
      mainBoxElem.style.height = height + "px";// 裁剪框变化后，设置高度
      mainBoxElem.style.top = mainBoxElem.offsetTop - addHeight + "px";// 裁剪框相对于父控件的距离
    };

    // 左边移动
    function leftMove(e) {
      var x = e.clientX;// 鼠标x坐标
//      if(x < getPosition(cropimgElem).left){
//          x = getPosition(cropimgElem).left;
//      }
      if (x > maxX || x < minX) {
        return;
      }
      var mainX = getPosition(mainBoxElem).left;
      var widthBefore = mainBoxElem.offsetWidth -2;// 裁剪框变化前的宽度
      var addWidth = mainX - x;// 鼠标移动后，裁剪框增加的宽度
      var width = widthBefore + addWidth;
      if (width < 1) {
        return;
      }
      mainBoxElem.style.width = width + "px";// 裁剪框变化后，设置宽度
      mainBoxElem.style.left = mainBoxElem.offsetLeft - addWidth + "px";// 裁剪框变化后，设置到父元素左边的距离
    };

    // 下边移动
    function downMove(e) {
      var y = e.clientY;// 鼠标y坐标
//      if(y > getPosition(cropimgElem).top + cropimgElem.offsetHeight){
//          y = getPosition(cropimgElem).top + cropimgElem.offsetHeight;
//      }
      if (y > maxY || y < minY) {
        return;
      }
      var heightBefore = mainBoxElem.offsetHeight - 2;// 裁剪框变化前的高度
      var mainY = getPosition(mainBoxElem).top;// 裁剪框相对于屏幕上边的距离
      var addHeight = y - heightBefore - mainY;// 增加的高度
      var height = heightBefore + addHeight;
      if (height < 1) {
        return;
      }
      mainBoxElem.style.height = height + "px";// 裁剪框变化后，设置高度
    };

    // 设置裁剪框的位置
    function setChoice() {
      var top = mainBoxElem.offsetTop;
      var right = mainBoxElem.offsetLeft + mainBoxElem.offsetWidth;
      var bottom = mainBoxElem.offsetTop + mainBoxElem.offsetHeight;
      var left = mainBoxElem.offsetLeft;
      var cropimg2 = document.getElementById("cropimg2");
      cropimg2.style.clip = "rect(" + top + "px, " + right + "px, " + bottom + "px, " + left + "px)";

      setPreview();
    };

    // 预览函数
    function setPreview() {
      var top = mainBoxElem.offsetTop;
      var right = mainBoxElem.offsetLeft + mainBoxElem.offsetWidth;
      var bottom = mainBoxElem.offsetTop + mainBoxElem.offsetHeight;
      var left = mainBoxElem.offsetLeft;
      var previewImg = document.getElementById("cropimg3");
      previewImg.style.top = -top + "px";
      previewImg.style.left = -left + "px";
      previewImg.style.clip = "rect(" + top + "px, " + right + "px, " + bottom + "px, " + left + "px)";
    }

  };

  // 获取元素相对于屏幕左边的距离 offsetLeft，offsetTop
  function getPosition(node) {
    var left = node.offsetLeft;
    var top = node.offsetTop;
    var parent = node.offsetParent;
    while (parent != null) {
      left += parent.offsetLeft;
      top += parent.offsetTop;
      parent = parent.offsetParent;
    }
    return {"left":left,"top":top};
  };
</script>
</body>
</html>
